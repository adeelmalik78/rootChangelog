pipeline {
  agent any
  environment {
    DB_CREDS = credentials('PostgresCredentials')
    PATH="/opt/liquibase/liquibase-4.25.1:$PATH"
  }

  stages {

    stage('Move uploaded script to DBScripts directory') {
      steps {
        cleanWs()
        sh 'git clone https://github.com/adeelmalik78/rootChangelog.git'
        withFileParameter('THEFILE') {
            sh '''
                if [ -z "$THEFILE_FILENAME" ]
                then
                    echo "No file provided ...."
                    exit 0
                elif [[ $THEFILE_FILENAME == *".zip" ]]
                  then
                    cd rootChangelog
                    unzip $THEFILE -d DBAUploads
                    ls -l DBAUploads
                else
                    cd rootChangelog
                    ls -l
                    echo "**** THEFILE=$THEFILE **** and **** THEFILE_FILENAME=$THEFILE_FILENAME ****"
                    mv $THEFILE DBAUploads/$THEFILE_FILENAME
                    ls -alh DBAUploads
                    # cat DBAUploads/$THEFILE_FILENAME
                fi
            '''
        }
      }
    }

    stage('Liquibase Flow') {
      steps {
        sh '''
            cd rootChangelog
            liquibase --url=${DB_URL} \
                      --username=$DB_CREDS_USR \
                      --password=$DB_CREDS_PSW \
                      flow \
                      --flow-file=Flowfiles/liquibase-update.flowfile.yaml
        '''
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: "rootChangelog/reports", reportFiles: 'update.report.html', reportName: 'Update_HTML_Report', reportTitles: ''])
      }
    }


    // stage('Liquibase Quality Checks') {
    //   steps {
    //     sh '''
    //         export PATH=/opt/liquibase/liquibase-4.25.1:$PATH
    //         cd rootChangelog
    //         liquibase checks run
    //     '''
    //   }
    // }
    
    // stage('Changelog Validation') {
    //   steps {
    //     sh '''
    //         export PATH=/opt/liquibase/liquibase-4.25.1:$PATH
    //         cd rootChangelog
    //         liquibase validate
    //     '''    
    //   }
    // }

    // stage('Liquibase Status') {
    //   steps {
    //     sh '''
    //         export PATH=/opt/liquibase/liquibase-4.25.1:$PATH
    //         cd rootChangelog
    //         liquibase status --verbose
    //     '''    
    //   }
    // }    

    // stage('Liquibase Update') {
    //   steps {
    //     sh '''
    //         export PATH=/opt/liquibase/liquibase-4.25.1:$PATH
    //         cd rootChangelog
    //         liquibase update
    //         ls -alh
    //     '''    
    //     // publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: "rootChangelog/reports", reportFiles: 'update.report.html', reportName: 'Update_HTML_Report', reportTitles: ''])

    //   }
    // }  

    // stage('Liquibase History') {
    //   steps {
    //     sh '''
    //         export PATH=/opt/liquibase/liquibase-4.25.1:$PATH
    //         cd rootChangelog
    //         liquibase history
    //     '''    
    //   }
    // }  
    
  }  // end stages
} // end pipeline

